#!/usr/bin/env bash
# Docker Compose Run Script

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd -P)/envrc"

# Default arguments
update_docker_images=false
update_repo=false
update_data=false

# Process arguments
while :
do
  case "${1:-}" in
    -i | --update-docker-images)
      update_docker_images=true
      shift
      ;;
    -r | --update-repo)
      update_repo=true
      shift
      ;;
    -d | --update-data)
      update_data=true
      shift
      ;;
    --) # End of all options
      shift
      break
      ;;
    -*)
      e_abort "Error: Unknown option: ${1}"; return 1
      ;;
    *)  # No more options
      break
      ;;
  esac
done

# Start only the specified containers
docker_compose_start_only(){
  docker-compose up -d --no-deps "$@"
}

# Set working directory
cd "${APPDIR}" || exit

# Update docker images
if [[ "$update_docker_images" == true ]]; then
  docker-compose build
  docker-compose pull
fi

# Update repo
if [[ "$update_repo" == true ]]; then
  update_repository
fi

# Update data containers
if [[ "$update_data" == true ]]; then
  docker_compose_start_only r10k
else
  docker-compose up -d
fi
