#!/usr/bin/env bash
# AWS CloudFormation tasks

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd -P)/env.sh"

# CLI Arguments
CMD="${1:-}"
CFN_STACK_ALIAS="${2:-}"
process_cfn_stacks "$CFN_STACK_ALIAS" "$CMD"

# Process arguments
case "$CMD" in
  create)
    check_stack_name
    create_stack "$CFN_CMD_ARGS"
    wait_for_stack "$CFN_STACK_NAME"
    ;;
  update)
    check_stack_name
    update_stack "$CFN_CMD_ARGS"
    wait_for_stack "$CFN_STACK_NAME"
    ;;
  delete)
    check_stack_name
    delete_stack "$CFN_STACK_NAME"
    wait_for_stack "$CFN_STACK_NAME"
    ;;
  validate)
    if [[ -n "$CFN_STACK_ALIAS" ]]; then
      validate_stack "$CFN_STACK_BODY"
    else
      validate_stacks "$CFN_STACKS_PATH"
    fi
    ;;
  upload)
    upload_cfn_templates "$CFN_STACKS_PATH" "$CFN_STACKS_S3_PATH"
    ;;
  *)
    usage
    ;;
esac
