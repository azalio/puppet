#!/usr/bin/env bash
# AWS CloudFormation tasks

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)/../environment.sh"

# Creates a new stack
create_stack(){
  local args="${*:?}"
  e_info 'Creating stack'
  eval "aws cloudformation create-stack ${args}"
}

# Update an existing stack
update_stack(){
  local args="${*:?}"
  e_info 'Updating stack'
  eval "aws cloudformation update-stack ${args}"
}

# Deletes an existing stack
delete_stack(){
  local name="${1:?}"
  e_warn "Deleting stack ${name}"
  eval "aws cloudformation delete-stack --stack-name ${name}"
}

# Validate stack
validate_stack(){
  local body="${1:?}"
  e_info "Validating ${body}"
  aws cloudformation validate-template \
    --output table \
    --template-body "file://${body}"
}

# Validate all stacks
validate_stacks(){
  local stacks_path="${1:?}"
  for stack in ${stacks_path}/*.json; do
    validate_stack "$stack"
  done
}

# Wait for stack to finish
wait_for_stack(){
  local name="${1:?}"
  if ! vgs_aws_cfn_wait "$name"; then
    e_abort "FATAL: The stack ${name} failed"
  fi
}

# Upload CloudFormation templates to S3
upload_cfn_templates(){
  local src="${1:?}/"
  local dst="${2:?}/"
  if aws s3 sync "$src" "$dst" --delete; then
    e_info "Synced ${src} to ${dst}"
  else
    e_abort "Could not sync ${src} to ${dst}"
  fi
}

usage(){
  echo "USAGE: ${BASH_SOURCE[0]} [COMMAND] [STACK]" >&2
  echo "COMMANDS: create | update | delete | validate | upload" >&2
  echo "STACKS: vgh" >&2
  return 1
}

# xVARs
e_header 'Info:'
e_info "Stack name: ${CFN_STACK_NAME:?}"
e_info "Stack template body: ${CFN_STACK_BODY:?}"
e_info "Stack command arguments: ${CFN_CMD_ARGS:?}"
e_info "Stack path: ${CFN_STACKS_PATH:?}"
e_info "Stack S3 path: ${CFN_STACKS_S3_PATH:?}"

# Process arguments
e_header 'CloudFormation:'
CMD="${1:-}"
[[ -n "$CMD" ]] || usage
CFN_STACK="${2:-}"
process_cfn_stacks "$CMD"
case "$CMD" in
  create)
    [[ -n "$CFN_STACK" ]] || usage
    create_stack "$CFN_CMD_ARGS"
    wait_for_stack "$CFN_STACK"
    ;;
  update)
    [[ -n "$CFN_STACK" ]] || usage
    update_stack "$CFN_CMD_ARGS"
    wait_for_stack "$CFN_STACK"
    ;;
  delete)
    [[ -n "$CFN_STACK" ]] || usage
    delete_stack "$CFN_STACK"
    wait_for_stack "$CFN_STACK"
    ;;
  validate)
    if [[ -n "$CFN_STACK" ]]; then
      validate_stack "$CFN_STACK_BODY"
    else
      validate_stacks "$CFN_STACKS_PATH"
    fi
    ;;
  upload)
    upload_cfn_templates "$CFN_STACKS_PATH" "$CFN_STACKS_S3_PATH"
    ;;
  *)
    usage
    ;;
esac
