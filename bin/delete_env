#!/usr/bin/env bash
# Delete stale environments (local & remote branch plus S3 paths)
#
# Use the `git-show-merged-branches` to make list the branches, and use a
# 'for' loop to delete them.
# `for branch in $(git-show-merged-branches); do bin/delete_env ${branch}; done`

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd -P)/envrc"

# Use `hub` to delete local and remote git branches
delete_git_branch(){
  if ! git delete-branch "${@}"; then
    e_error "Could not delete '$*'"
  fi
}

# Delete the S3 object
delete_s3_path(){
  if ! aws s3 rm "${@}"; then
    e_error "Could not delete '$*'"
  fi
}

# Main script logic
main(){
  for branch in "$@"; do
    # Reload new environment
    export ENVTYPE="$branch"
    export SKIP_PRE_PUSH_HOOK=true
    # shellcheck disable=1090
    . "$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd -P)/envrc"

    # Delete git branches (local and remote)
    delete_git_branch "$branch"

    # Delete S3 stored environments
    delete_s3_path "${ENV_S3PATH}"
    delete_s3_path "${HIERA_S3PATH}" --recursive
    delete_s3_path "${SECURE_S3PATH}" --recursive
  done
}

main "$@"
