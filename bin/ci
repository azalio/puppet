#!/usr/bin/env bash
# Continuous Integration / Continuous Deployment tasks

# Load environment
envfile="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)/../environment.sh"
# shellcheck disable=1090
[[ -s "$envfile" ]] && . "$envfile"

# Download dotenv
get_dotenv(){
  e_info 'Get dotenv'
  aws s3 cp "${AWS_ASSETS_S3_PATH}/.env" "${APPDIR}/.env"
}

# CI Install
ci_install(){
  pip install --user --upgrade pip awscli
  get_dotenv
  cd "${APPDIR}/dist/profile" || exit
  bundle install --without development system_tests --path vendor
  bundle exec rake spec_prep
}

ci_test(){
  bash -c "${APPDIR}/bin/cfn validate"
  cd "${APPDIR}/dist/profile" || exit
  bundle exec rake test
}

ci_deploy(){
  if [[ ${PR} == false ]]; then
    bash -c "${APPDIR}/bin/cfn upload"
    bash -c "${APPDIR}/bin/lambda upload"
  else
    echo 'Deployment is not allowed from pull requests' >&2
  fi
}

# xVARs
e_header 'Info:'
e_info "Application directory: ${APPDIR:?}"
e_info "Pull request: ${PR:?}"

# Process arguments
e_header 'CI:'
case "${1:-}" in
  install)
    ci_install
    ;;
  test)
    ci_test
    ;;
  deploy)
    ci_deploy
    ;;
  *)
    e_abort "USAGE: ${BASH_SOURCE[0]} [install | test | deploy]"
    ;;
esac
