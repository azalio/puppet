#!/usr/bin/env bash
# Continuous Integration / Continuous Deployment tasks

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd -P)/env.sh"

# CI Install
ci_install(){
  e_info 'Ensure latest Python PIP and AWS-CLI'
  pip install --user --upgrade pip awscli

  bash -c "${APPDIR}/bin/app download-private"

  e_info 'Install required testing gems'
  cd "${APPDIR}/dist/profile" || exit
  bundle install --without development system_tests --path vendor

  e_info 'Install required puppet module'
  bundle exec rake spec_prep
}

ci_test(){
  bash -c "${APPDIR}/bin/cfn validate"

  e_info 'Running tests'
  cd "${APPDIR}/dist/profile" || exit
  bundle exec rake test
}

send_ec2_run_command(){
  local role
  role=${1:?}

  e_info "Looking for instances tagged ${role}"
  ids=$(aws ec2 describe-instances \
    --filter Name=tag:Role,Values="$role" Name=instance-state-name,Values=running \
    --query 'Reservations[].Instances[].InstanceId' \
    --output text)
  e_info "Found ids: ${ids}, for group ${role}"

  e_info "Sending ec2 run command"
  # shellcheck disable=2086
  command_id=$(aws ssm send-command \
    --document-name "AWS-RunShellScript" \
    --instance-ids $ids \
    --parameters $'{"commands":["/opt/puppetlabs/puppet/bin/r10k deploy environment --puppetfile --verbose"]}' \
    --comment "Deploy R10K environment" \
    --timeout-seconds 600 \
    --query 'Command.CommandId' \
    --output text)

  e_info "Wait until at least 1 invocation returns succes(id: $command_id)"
  until [[ $(aws ssm list-commands --region us-east-1 --command-id "$command_id" --query 'Commands[].Status' --output text) =~ 'Success' ]]; do sleep 1; done
  e_info 'Done'
}

ci_deploy(){
  if [[ ${PR} == false ]]; then
    bash -c "${APPDIR}/bin/cfn upload"
    bash -c "${APPDIR}/bin/lambda upload"
    bash -c "${APPDIR}/bin/app upload"
    send_ec2_run_command zeus
  else
    echo 'Deployment is not allowed from pull requests' >&2
  fi
}

# xVARs
e_header 'Info:'
e_info "Application directory: ${APPDIR:?}"
e_info "Pull request: ${PR:?}"

# Process arguments
e_header 'CI:'
case "${1:-}" in
  install)
    ci_install
    ;;
  test)
    ci_test
    ;;
  deploy)
    ci_deploy
    ;;
  *)
    e_abort "USAGE: ${BASH_SOURCE[0]} [install | test | deploy]"
    ;;
esac
