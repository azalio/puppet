#!/usr/bin/env bash
# Bootstraps RHEA - Puppet Master of Masters

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd -P)/envrc"

# VARs
export PP_SERVER=puppet.ghn.me
export PP_ROLE=rhea
export PP_PROJECT=vpm
export PP_AGENT_RUN=false
export PP_CERTNAME
PP_CERTNAME="$(curl -s http://169.254.169.254/latest/meta-data/instance-id)"

# PATHs
PATH="/opt/puppetlabs/bin:/opt/puppetlabs/puppet/bin:/usr/local/bin:${PATH}"

# Set working directory
cd "${APPDIR}" || exit

# Bootstrap Puppet Agent
bash ./bootstrap

# Bootstrap modules
modules=(
  puppetlabs-stdlib
  puppetlabs-apt
  puppetlabs-git
  garethr-docker
)

# Install Puppet modules
for mod in "${modules[@]}"; do puppet module install "$mod"; done

# Apply bootstrap manifest
cat << EOP | puppet apply --verbose
  include ::git
  include ::docker
  class {'::docker::compose': version => '1.7.1'}
EOP

bash bin/run
