#!/usr/bin/env bash
# Docker Compose Run Script

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd -P)/envrc"

# Default arguments
update_docker_images=false
update_repo=false
local_puppet=false

# Process arguments
while :; do
  case "${1:-}" in
    -i | --update-docker-images)
      update_docker_images=true
      shift
      ;;
    -r | --update-repo)
      update_repo=true
      shift
      ;;
    -l | --local)
      local_puppet=true
      shift
      ;;
    --) # End of all options
      shift
      break
      ;;
    -*)
      e_abort "Error: Unknown option: ${1}"; return 1
      ;;
    *)  # No more options
      break
      ;;
  esac
done

# Set working directory
cd "${APPDIR}" || exit

# Update docker images
if [[ "$update_docker_images" == true ]]; then
  docker-compose pull
  docker-compose build
fi

# Update repo
if [[ "$update_repo" == true ]]; then
  git fetch --all && git reset --hard origin/production
fi

# Start containers
if [[ "$local_puppet" == true ]]; then
  docker-compose up -d server
else
  docker-compose up -d
fi
