#!/usr/bin/env bash
# Docker Compose Run Script

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd -P)/envrc"

# Default arguments
update_repo=false
update_docker_images=false

# Process arguments
while :; do
  case "${1:-}" in
    -r | --update-repo)
      update_repo=true
      shift
      ;;
    -i | --update-docker-images)
      update_docker_images=true
      shift
      ;;
    --) # End of all options
      shift
      break
      ;;
    -*)
      e_abort "Error: Unknown option: ${1}"; return 1
      ;;
    *)  # No more options
      break
      ;;
  esac
done

# Set working directory
cd "$APPDIR" || exit

# Update repo
if [[ "$update_repo" == true ]]; then
  git fetch --all
  git reset --hard origin/production
  download_private_data
fi

# Update docker images
if [[ "$update_docker_images" == true ]]; then
  docker-compose pull
  docker-compose build
fi

# Start containers
docker-compose up -d
