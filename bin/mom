#!/usr/bin/env bash
# Bootstraps Puppet Master of Masters

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd -P)/envrc"

# Bootstrap Puppet Agent
bash "${APPDIR}/bootstrap" || true

# VARs
export PP_SERVER=puppet.ghn.me
export PP_ROLE=rhea
export PP_PROJECT=vpm

# Commands
PPT=/opt/puppetlabs/bin/puppet

# Bootstrap modules
modules=(
  puppetlabs-stdlib
  puppetlabs-apt
  puppetlabs-git
  garethr-docker
)

# Install Puppet modules
for mod in "${modules[@]}"; do $PPT module install "$mod"; done

# Apply bootstrap manifest
cat << EOP | $PPT apply --verbose
  include ::git
  include ::docker
  class {'::docker::compose': version => '1.7.1'}
EOP
