#!/usr/bin/env bash
# Update Puppet Master
# This file is managed by Puppet
# @author Vlad Ghinea

# Bash strict mode
set -euo pipefail
IFS=$'\n\t'

# Arguments
environment=${1:-production}
role=${2:-none}

# VARs
project_name=<%= scope().call_function('hiera',['project_name']) %>
project_path=<%= scope().call_function('hiera',['project_path']) %>
assets_bucket=<%= @aws_assets_bucket %>

# Load VGS Library
# shellcheck disable=1090,1091
. /opt/vgs/load 2>/dev/null || . "${HOME}/vgs/load" 2>/dev/null || true

# Use Puppets gems and paths
unset GEM_HOME GEM_PATH
PATH=/opt/puppetlabs/bin:/opt/puppetlabs/puppet/bin:/usr/local/bin:${PATH}

# Deploy R10k environments
r10k_deploy(){
  r10k deploy environment --puppetfile --verbose
}

# Retrieve Hiera Data
get_hiera_data(){
  environmentpath=$(puppet config print environmentpath)

  for env in ${environmentpath}/*; do
    environmentname=$(basename "$env")

    e_info "Sync hiera data for the '${environmentname}' environment"
    if ! aws s3 sync \
      --delete \
      "s3://${assets_bucket}/${project_name}/${environmentname}/data" \
      "${environmentpath}/${environmentname}/private/data"
    then
      e_warn 'Could not get private hiera data'
    fi
  done
}

# Apply puppet
puppet_apply(){
  manifest="$(puppet config print manifest)/site.pp"
  local exit_code=0

  echo 'Apply Puppet manifest'
  FACTER_ROLE=${role} puppet apply \
    --environment "$environment" \
    --verbose \
    --detailed-exitcodes \
    "$manifest" \
  || exit_code=$?

  # Process the exit code
  if [[ $exit_code == 0 ]]; then
    e_info 'The run succeeded with no changes or failures'
  elif [[ $exit_code == 1 ]]; then
    e_abort 'The run failed'
  elif [[ $exit_code == 2 ]]; then
    e_info 'The run succeeded, and some resources were changed'
  elif [[ $exit_code == 4 ]]; then
    e_abort 'The run succeeded, and some resources failed'
  elif [[ $exit_code == 6 ]]; then
    e_abort 'The run succeeded, and included both changes and failures'
  else
    e_abort 'Unknown run exit code'
  fi
}

main(){
  r10k_deploy
  get_hiera_data
  puppet_apply
}

main "$@"
