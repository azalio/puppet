#!/usr/bin/env bash
# Update Puppet Master
# This file is managed by Puppet
# @author Vlad Ghinea

# VARs
PATH=/opt/puppetlabs/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
environment=${1:-production}
role=${2:-none}
project_name=<%= scope.function_hiera(['project_name']) %>
project_path=<%= scope.function_hiera(['project_path']) %>
assets_bucket=<%= @aws_assets_bucket %>
environmentpath=$(puppet config print environmentpath)
manifest="$(puppet config print manifest)/site.pp"

# Load VGS Library
# shellcheck disable=1090,1091
. /opt/vgs/load 2>/dev/null || . "${HOME}/vgs/load" 2>/dev/null || true

# Deploy R10k environments
r10k_deploy(){
  r10k deploy environment --puppetfile --verbose
}

# Retrieve Hiera Data
get_hiera_data(){
  for env in ${environmentpath}/*; do
    environmentname=$(basename "$env")

    e_info "Sync hiera data for the '${environmentname}' environment"
    if ! aws s3 sync \
      --delete \
      "s3://${assets_bucket}/${project_name}/${environmentname}/data" \
      "${environmentpath}/${environmentname}/data"
    then
      e_warn 'Could not get private hiera data'
    fi
  done
}

# Apply puppet
puppet_apply(){
  local exit_code=0

  echo 'Apply Puppet manifest'
  (
    # Clean-up path (mostly get rid of RVM)
    FACTER_ROLE=${role} puppet apply \
      --environment "$environment" \
      --verbose \
      --detailed-exitcodes \
      "$manifest"
  ) || exit_code=$?

  # Process the exit code
  if [[ $exit_code == 0 ]]; then
    e_info 'The run succeeded with no changes or failures'
  elif [[ $exit_code == 1 ]]; then
    e_abort 'The run failed'
  elif [[ $exit_code == 2 ]]; then
    e_info 'The run succeeded, and some resources were changed'
  elif [[ $exit_code == 4 ]]; then
    e_abort 'The run succeeded, and some resources failed'
  elif [[ $exit_code == 6 ]]; then
    e_abort 'The run succeeded, and included both changes and failures'
  else
    e_abort 'Unknown run exit code'
  fi
}

main(){
  r10k_deploy
  get_hiera_data
  puppet_apply
}

main "$@"
