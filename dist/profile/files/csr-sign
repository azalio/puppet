#!/opt/puppetlabs/puppet/bin/ruby

require 'yaml'
require 'openssl'
require 'aws-sdk'
require 'logger'

# Environment
environment = ENV['ENVTYPE'] || 'production'
master_role = 'zeus'

# Logging
logger = Logger.new('/tmp/csr_sign.log')

# Configuration
cfg = YAML.load `/opt/puppetlabs/bin/hiera -f yaml csr_config \
                ::role=#{master_role} ::environment=#{environment}`

# Load AWS SDK
aws_region = ENV['AWS_DEFAULT_REGION'] || 'us-east-1'
ec2 = Aws::EC2::Resource.new(region: aws_region)

# VARs
instance_id, image_name, project, role = nil

# Read CSR
csr = OpenSSL::X509::Request.new(STDIN.read)

# Get a list of custom attributes
atts = csr.attributes

# Do not sign if there aren't any custom csr attributes
if atts.empty?
  logger.error 'Authorization failed! The CSR has no attributes!'
  exit 1
end

# Get challenge password
begin
  challenge_password = atts.select { |att| att.oid == 'challengePassword' }
                           .first.value.value.first.value.strip
rescue => e
  logger.warn 'Could not find challengePassword in the attributes ' \
              "(#{e.message})!"
  challenge_password = nil
end

# Get extensions
begin
  exts = atts.select { |att| att.oid == 'extReq' }
             .first.value.value.first.value
rescue => e
  logger.warn 'Could not find other extensions in the attributes! ' \
              "(#{e.message})!"
  exts = nil
end

# Get extension requests
exts.each do |ext|
  id   = ext.value[0].value.strip
  resp = ext.value[1].value.gsub(/([\x00-\x1f])/, '').strip

  instance_id = resp if id == '1.3.6.1.4.1.34380.1.1.2'
  image_name = resp  if id == '1.3.6.1.4.1.34380.1.1.3'
  project = resp     if id == '1.3.6.1.4.1.34380.1.1.7'
  role = resp        if id == '1.3.6.1.4.1.34380.1.1.13'
end

# Get authorized password
begin
  authorized_password = cfg[project]['challengePassword']
rescue => e
  logger.warn 'Could not find challengePassword in the configuration! ' \
              "(#{e.message})!"
  authorized_password = nil
end

# Sign if password matches
if authorized_password && challenge_password == authorized_password
  logger.info 'Node authorized based on the provided challengePassword'
  exit 0
end

# Sign if its a known instance
instances_pool = ec2.instances.map(&:id)
if instances_pool.include?(instance_id)
  logger.info "Node authorized based on instance id (#{instance_id})"
  exit 0
end

# Sign if the base image is known
ami_pool = ec2.images(owners: ['self']).map(&:id)
if ami_pool.include?(image_name)
  logger.info "Node authorized based on image id (#{image_name})"
  exit 0
end

# JUST DON'T
logger.error 'Authorization failed!'
exit 1
