#!/usr/bin/env bash

# Bash strict mode
set -euo pipefail
IFS=$'\n\t'

# VARs
export APPDIR TMPDIR NOW VERSION VERSION_FILE CHANGELOG_FILE
APPDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
TMPDIR=$(mktemp -d 2>/dev/null || mktemp -d -t 'tmp')
NOW="$(date +"%Y%m%d_%H%M%S")"
VERSION_FILE="${APPDIR}/VERSION"
CHANGELOG_FILE="${APPDIR}/CHANGELOG.md"
VERSION=$(cat "$VERSION_FILE" || echo '0.0.0')

# Load private environment
# shellcheck disable=1090
. "${APPDIR}/.env" 2>/dev/null || true

# Load VGS library
# shellcheck disable=1090,1091
. /opt/vgs/load 2>/dev/null || . ~/vgs/load 2>/dev/null || true

# Load functions
# shellcheck disable=1090
for file in ${APPDIR}/lib/*.sh; do . "$file"; done

# Detect environment
GIT_BRANCH=$(git -C "$APPDIR" symbolic-ref --short HEAD 2>/dev/null || echo '')
GIT_SHA1=$(git -C "$APPDIR" rev-parse --short HEAD 2>/dev/null || echo '0')
if [[ -n "${ENVTYPE:-}" ]]; then
  # If env var
  ENVTYPE="$ENVTYPE"
elif [[ -n "${GIT_BRANCH:-}" ]]; then
  # If git branch
  ENVTYPE="$GIT_BRANCH"
elif [[ -n "${TRAVIS_BRANCH:-}" ]]; then
  # If TravisCI git branch
  ENVTYPE="$TRAVIS_BRANCH"
elif [[ -n "${CIRCLE_BRANCH:-}" ]]; then
  # If CircleCI git branch
  ENVTYPE="$CIRCLE_BRANCH"
elif [[ -n "${DEPLOYMENT_GROUP_NAME:-}" ]]; then
  # If AWS CodeDeploy hook
  ENVTYPE="$DEPLOYMENT_GROUP_NAME"
else
  # Default
  ENVTYPE=${ENVTYPE:-production}
fi
# Rename master to production
if [[ "$ENVTYPE" == 'master' ]]; then ENVTYPE='production'; fi
# Export the actual ENVTYPE
export ENVTYPE

# Detect CI environment
export CI=${CI:-false}
export PR=false
export BUILD=${GIT_SHA1:-0}
if [[ ${CIRCLECI:-false} == true ]]; then
  export PR=${CIRCLE_PR_NUMBER}
  export BUILD=${CIRCLE_BUILD_NUM}
  git config --global user.name "CircleCI"
elif [[ ${TRAVIS:-false} == true ]]; then
  export PR=${TRAVIS_PULL_REQUEST}
  export BUILD=${TRAVIS_BUILD_NUMBER}
  git config --global user.name "TravisCI"
fi

# VARs
export AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION:-us-east-1}"
export AWS_ASSETS_BUCKET='vladgh'
export SSL_S3PATH="s3://${AWS_ASSETS_BUCKET}/ssl"
export VAULT_S3PATH="s3://${AWS_ASSETS_BUCKET}/vault/${ENVTYPE}"
export HIERA_S3PATH="s3://${AWS_ASSETS_BUCKET}/hieradata/${ENVTYPE}"
