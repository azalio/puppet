version: '2'

services:
  server:
    image: vladgh/puppetserver:aws
    hostname: puppet.ghn.me
    ports:
      - '8140:8140'
    volumes_from:
      - r10k
    environment:
      AUTOSIGN: 'true'
      JAVA_ARGS: '-Xms256m -Xmx256m'
    restart: 'on-failure:5'
  r10k:
    image: vladgh/r10k:latest
    hostname: r10k-agent
    volumes:
      - ~/.aws:/root/.aws:ro
      - .:/etc/puppetlabs/code/environments/production
      - ./hiera.yaml:/etc/puppetlabs/puppet/hiera.yaml:ro
      - ./hieradata:/etc/puppetlabs/hieradata
    command: puppetfile install
    working_dir: /etc/puppetlabs/code/environments/production
    restart: 'no'
